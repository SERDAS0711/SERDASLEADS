<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Immobilien Abarbeitung – Compat Version</title>
  <style>
    /* Apple-ähnliches, minimalistisches Design */
    body {
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: #333;
      line-height: 1.6;
    }
    header {
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8em;
    }
    .container {
      max-width: 1000px;
      margin: 30px auto;
      padding: 0 20px;
    }
    /* CSV Upload */
    #csvInputs {
      margin-bottom: 30px;
      background-color: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    #csvInputs label {
      font-weight: bold;
      display: block;
      margin-bottom: 8px;
    }
    #csvInputs input[type="file"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 100%;
      max-width: 400px;
    }
    /* Filter & Sortierung */
    #filterSortSection {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      align-items: flex-end;
      background-color: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    #filterSortSection > div {
      flex: 1;
      min-width: 200px;
    }
    #filterSortSection label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }
    #filterSortSection input[type="text"],
    #filterSortSection select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    /* Buttons */
    #applyFilterSortBtn, #toggleViewBtn, #exportBtn, #saveToCloudBtn, #loadFromCloudBtn {
      padding: 12px 20px;
      border: none;
      background-color: #007aff;
      color: #fff;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-top: 10px;
    }
    #applyFilterSortBtn:hover,
    #toggleViewBtn:hover,
    #exportBtn:hover,
    #saveToCloudBtn:hover,
    #loadFromCloudBtn:hover {
      background-color: #005bb5;
    }
    /* Statistik */
    #statistics {
      margin-bottom: 20px;
      font-weight: bold;
      text-align: center;
    }
    /* Einzel-Card Ansicht */
    .card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 30px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.4em;
      color: #007aff;
    }
    .section {
      margin-bottom: 20px;
    }
    .section label {
      font-size: 0.9em;
      margin-bottom: 8px;
      display: block;
      color: #555;
    }
    input[type="date"],
    textarea {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    textarea {
      resize: vertical;
    }
    /* Navigation */
    .navigation {
      text-align: center;
      margin-top: 20px;
    }
    .navigation button {
      padding: 12px 20px;
      margin: 0 10px;
      border: none;
      background-color: #007aff;
      color: #fff;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .navigation button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .navigation .progress {
      display: inline-block;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1em;
    }
    /* Mehrfachansicht (Tabelle) */
    #multiSelectTable {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    #multiSelectTable th, #multiSelectTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #multiSelectTable th {
      background-color: #f2f2f2;
    }
    /* Links */
    a {
      color: #007aff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .no-results {
      text-align: center;
      font-size: 1.2em;
      color: #ff3b30;
      font-weight: bold;
      margin-top: 40px;
    }
  </style>

  <!-- Firebase SDKs (Compat-Version ohne Analytics) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js";

    // Deine Firebase-Konfiguration
    const firebaseConfig = {
      apiKey: "DEIN_API_KEY",
      authDomain: "DEIN_PROJEKT.firebaseapp.com",
      projectId: "DEIN_PROJEKT",
      storageBucket: "DEIN_PROJEKT.appspot.com",
      messagingSenderId: "DEINE_SENDER_ID",
      appId: "1:DEINE_SENDER_ID:web:XXXX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
  </script>
</head>
<body>
  <header>
    <h1>Immobilien Abarbeitung – Compat Version</h1>
  </header>
  <div class="container">
    <!-- CSV Upload -->
    <div id="csvInputs">
      <label for="csvFileInput1">CSV Datei 1:</label>
      <input type="file" id="csvFileInput1" accept=".csv,text/csv" />
      <br/><br/>
      <label for="csvFileInput2">CSV Datei 2:</label>
      <input type="file" id="csvFileInput2" accept=".csv,text/csv" />
    </div>

    <!-- Filter & Sortierung -->
    <div id="filterSortSection">
      <div>
        <label for="searchInput">Suche</label>
        <input type="text" id="searchInput" placeholder="Suchbegriff eingeben…" />
      </div>
      <div>
        <label for="contactFilter">Kontaktstatus</label>
        <select id="contactFilter">
          <option value="all">Alle</option>
          <option value="contacted">Kontaktiert</option>
          <option value="not_contacted">Nicht kontaktiert</option>
        </select>
      </div>
      <div>
        <label for="notesFilter">Notizen</label>
        <select id="notesFilter">
          <option value="all">Alle</option>
          <option value="with_notes">Mit Notizen</option>
          <option value="without_notes">Ohne Notizen</option>
        </select>
      </div>
      <div>
        <label for="sortSelect">Sortieren nach</label>
        <select id="sortSelect">
          <option value="none">Keine Sortierung</option>
          <option value="preis_asc">Preis (aufsteigend)</option>
          <option value="preis_desc">Preis (absteigend)</option>
          <option value="wohnflaeche_asc">Wohnfläche (aufsteigend)</option>
          <option value="wohnflaeche_desc">Wohnfläche (absteigend)</option>
          <option value="ort_asc">Ort (A–Z)</option>
          <option value="ort_desc">Ort (Z–A)</option>
          <option value="datum_desc">Datum (neueste zuerst)</option>
          <option value="datum_asc">Datum (älteste zuerst)</option>
        </select>
      </div>
      <button id="applyFilterSortBtn">Anwenden</button>
    </div>

    <!-- Aktionen -->
    <div style="text-align:center; margin-bottom:20px;">
      <button id="toggleViewBtn">Wechsel zu Mehrfachansicht</button>
      <button id="exportBtn">Export CSV</button>
      <button id="saveToCloudBtn">Daten in Cloud speichern</button>
      <button id="loadFromCloudBtn">Daten aus Cloud laden</button>
    </div>

    <!-- Statistik -->
    <div id="statistics"></div>

    <!-- Anzeige-Bereich -->
    <div id="displayArea">
      <div id="cardContainer"></div>
      <div id="multiSelectContainer" style="display:none;"></div>
    </div>

    <!-- Navigation -->
    <div class="navigation" id="navigationArea">
      <button id="prevBtn" disabled>Vorherige</button>
      <button id="nextBtn" disabled>Nächste</button>
      <div class="progress" id="progressIndicator"></div>
    </div>
  </div>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    // -------------------------------------------------------
    // 1) Globale Variablen
    // -------------------------------------------------------
    let data1 = [], data2 = [], mergedData = [], filteredData = [];
    let currentIndex = 0;
    let viewMode = "single";
    let parsed1 = false, parsed2 = false;

    // -------------------------------------------------------
    // 2) DOM-Referenzen
    // -------------------------------------------------------
    const csvFileInput1 = document.getElementById('csvFileInput1');
    const csvFileInput2 = document.getElementById('csvFileInput2');
    const searchInput = document.getElementById('searchInput');
    const contactFilter = document.getElementById('contactFilter');
    const notesFilter = document.getElementById('notesFilter');
    const sortSelect = document.getElementById('sortSelect');
    const applyFilterSortBtn = document.getElementById('applyFilterSortBtn');
    const toggleViewBtn = document.getElementById('toggleViewBtn');
    const exportBtn = document.getElementById('exportBtn');
    const saveToCloudBtn = document.getElementById('saveToCloudBtn');
    const loadFromCloudBtn = document.getElementById('loadFromCloudBtn');
    const statisticsDiv = document.getElementById('statistics');
    const cardContainer = document.getElementById('cardContainer');
    const multiSelectContainer = document.getElementById('multiSelectContainer');
    const navigationArea = document.getElementById('navigationArea');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressIndicator = document.getElementById('progressIndicator');

    // -------------------------------------------------------
    // 3) CSV Upload
    // -------------------------------------------------------
    csvFileInput1.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      parseCSV(file, data => {
        data1 = data;
        parsed1 = true;
        console.log("CSV1 Länge:", data1.length);
        tryMergeData();
      });
    });
    csvFileInput2.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      parseCSV(file, data => {
        data2 = data;
        parsed2 = true;
        console.log("CSV2 Länge:", data2.length);
        tryMergeData();
      });
    });
    function parseCSV(file, callback) {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: results => callback(results.data),
        error: err => console.error("Fehler beim Parsen:", err)
      });
    }
    function tryMergeData() {
      if (parsed1 && parsed2) {
        const combined = data1.concat(data2);
        console.log("combined length:", combined.length);
        mergedData = removeDuplicates(combined);
        console.log("mergedData nach Duplikatentfernung:", mergedData.length);
        filteredData = [...mergedData];
        currentIndex = 0;
        updateDataView();
      }
    }
    function removeDuplicates(arr) {
      const seen = new Set(), res = [];
      for (const itm of arr) {
        const str = JSON.stringify(itm);
        if (!seen.has(str)) {
          seen.add(str);
          res.push(itm);
        }
      }
      return res;
    }

    // -------------------------------------------------------
    // 4) Filter & Sortierung
    // -------------------------------------------------------
    applyFilterSortBtn.addEventListener('click', updateDataView);
    function updateDataView() {
      console.log("updateDataView: mergedData =", mergedData.length);
      const term = searchInput.value.toLowerCase();
      filteredData = mergedData.filter(item =>
        Object.values(item).some(v => v && v.toString().toLowerCase().includes(term))
      );
      filteredData = filteredData.filter(item => {
        const st = getContactStatus(item);
        if (contactFilter.value === "contacted") return st.contacted;
        if (contactFilter.value === "not_contacted") return !st.contacted;
        return true;
      });
      filteredData = filteredData.filter(item => {
        const st = getContactStatus(item);
        if (notesFilter.value === "with_notes") return st.notes.trim() !== "";
        if (notesFilter.value === "without_notes") return !st.notes.trim();
        return true;
      });
      if (sortSelect.value !== 'none') sortFilteredData(sortSelect.value);
      currentIndex = 0;
      updateStatistics();
      console.log("nach Filter/Sort:", filteredData.length);
      if (filteredData.length) {
        if (viewMode === "single") {
          displayCard(currentIndex);
          navigationArea.style.display = "block";
          multiSelectContainer.style.display = "none";
        } else {
          displayMultiSelectView();
          navigationArea.style.display = "none";
        }
      } else {
        showNoResults();
      }
    }
    function sortFilteredData(mode) {
      switch(mode) {
        case 'preis_asc':
          filteredData.sort((a,b)=>toNum(a.Preis)-toNum(b.Preis)); break;
        case 'preis_desc':
          filteredData.sort((a,b)=>toNum(b.Preis)-toNum(a.Preis)); break;
        case 'wohnflaeche_asc':
          filteredData.sort((a,b)=>toNum(a["Wohnfläche"])-toNum(b["Wohnfläche"])); break;
        case 'wohnflaeche_desc':
          filteredData.sort((a,b)=>toNum(b["Wohnfläche"])-toNum(a["Wohnfläche"])); break;
        case 'ort_asc':
          filteredData.sort((a,b)=> (a.Ort||"").localeCompare(b.Ort||"")); break;
        case 'ort_desc':
          filteredData.sort((a,b)=> (b.Ort||"").localeCompare(a.Ort||"")); break;
        case 'datum_asc':
          filteredData.sort((a,b)=> new Date(a.Datum)-new Date(b.Datum)); break;
        case 'datum_desc':
          filteredData.sort((a,b)=> new Date(b.Datum)-new Date(a.Datum)); break;
      }
    }
    function toNum(v) {
      if (!v) return 0;
      return parseFloat(v.toString().replace(/[^\d\.]/g,""))||0;
    }

    // -------------------------------------------------------
    // 5) Linkify
    // -------------------------------------------------------
    function linkify(txt) {
      if (!txt) return "";
      const pat = /(\b(https?|ftp):\/\/[^\s]+)|(\bwww\.[^\s]+)/gim;
      return txt.replace(pat, m=> {
        let url=m.trim();
        if (!url.match(/^(https?|ftp):\/\//)) url='https://'+url;
        return `<a href="${url}" target="_blank">${m}</a>`;
      });
    }

    // -------------------------------------------------------
    // 6) Einzelansicht
    // -------------------------------------------------------
    function displayCard(i) {
      console.log("displayCard", i, filteredData.length);
      cardContainer.innerHTML="";
      if (!filteredData.length) { showNoResults(); return; }
      progressIndicator.textContent=`Immobilie ${i+1} von ${filteredData.length}`;
      const prop=filteredData[i];
      const card=document.createElement("div"); card.className="card";

      // Kontaktstatus
      const ks=document.createElement("div"); ks.className="section";
      ks.innerHTML=`<h2>Kontaktstatus</h2>`;
      const chk=document.createElement("input"); chk.type="checkbox";
      const lbl=document.createElement("label"); lbl.appendChild(chk); lbl.append(" Kontaktiert");
      ks.appendChild(lbl);
      const dLbl=document.createElement("label"); dLbl.textContent="Kontaktiert am:";
      ks.appendChild(dLbl);
      const dIn=document.createElement("input"); dIn.type="date";
      ks.appendChild(dIn);
      const nLbl=document.createElement("label"); nLbl.textContent="Notizen:";
      ks.appendChild(nLbl);
      const txt=document.createElement("textarea"); txt.rows=4;
      ks.appendChild(txt);
      card.appendChild(ks);

      // Details
      const ds=document.createElement("div"); ds.className="section";
      ds.innerHTML="<h2>Immobiliendetails</h2>";
      for(const k in prop) {
        const v=prop[k];
        if(v&&v.toString().trim()) {
          const dv=document.createElement("div");
          dv.innerHTML=`<strong>${k}:</strong> ${linkify(v)}`;
          ds.appendChild(dv);
        }
      }
      card.appendChild(ds);
      cardContainer.appendChild(card);

      loadContactStatus(prop,chk,dIn,txt);
      chk.addEventListener("change",()=>{ saveContactStatus(prop,chk,dIn,txt); updateStatistics(); });
      dIn.addEventListener("change",()=>{ saveContactStatus(prop,chk,dIn,txt); updateStatistics(); });
      txt.addEventListener("input",()=>{ saveContactStatus(prop,chk,dIn,txt); updateStatistics(); });

      updateNavigation();
    }
    function showNoResults(){
      cardContainer.innerHTML='<div class="no-results">Keine Ergebnisse gefunden.</div>';
      progressIndicator.textContent="";
    }

    // -------------------------------------------------------
    // 7) Mehrfachansicht + Batch
    // -------------------------------------------------------
    function displayMultiSelectView() {
      multiSelectContainer.innerHTML="";
      const tbl=document.createElement("table"); tbl.id="multiSelectTable";
      const ths=["Auswahl","Details","Kontaktstatus"];
      const thead=tbl.createTHead(), row=thead.insertRow(); ths.forEach(t=>{ const c=row.insertCell(); c.textContent=t; });
      const tbody=tbl.createTBody();
      filteredData.forEach((prop,idx)=>{
        const tr=tbody.insertRow();
        const c0=tr.insertCell(); const cb=document.createElement("input"); cb.type="checkbox"; cb.dataset.index=idx; c0.append(cb);
        const c1=tr.insertCell(); let dtext="",ct=0; for(const k in prop){ if(prop[k]&&ct<3){ dtext+=`${k}:${prop[k]} | `; ct++; }} c1.textContent=dtext.slice(0,-3);
        const c2=tr.insertCell(); c2.textContent=getContactStatus(prop).contacted?"Kontaktiert":"Nicht kontaktiert";
      });
      multiSelectContainer.append(tbl);
      const bs=document.createElement("div"); bs.className="section";
      bs.innerHTML=`<h2>Batch-Update</h2>
        <label><input type="checkbox" id="batchContacted"> Als kontaktiert markieren</label>
        <label>Kontaktiert am:<br><input type="date" id="batchDate"></label>
        <label>Notizen:<br><textarea id="batchNotes" rows="3"></textarea></label>
        <button id="applyBatchBtn">Batch Update anwenden</button>`;
      multiSelectContainer.append(bs);
      document.getElementById("applyBatchBtn").addEventListener("click",()=>{
        const bc=document.getElementById("batchContacted").checked;
        const bd=document.getElementById("batchDate").value;
        const bn=document.getElementById("batchNotes").value;
        multiSelectContainer.querySelectorAll("tbody input[type=checkbox]:checked").forEach(cb=>{
          const p=filteredData[+cb.dataset.index];
          localStorage.setItem(getPropertyKey(p),JSON.stringify({contacted:bc,contactDate:bd,notes:bn}));
        });
        alert("Batch Update durchgeführt."); updateStatistics(); updateDataView();
      });
    }

    // -------------------------------------------------------
    // 8) LocalStorage-Funktionen
    // -------------------------------------------------------
    function b64EncodeUnicode(str) {
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(m,p)=>String.fromCharCode('0x'+p)));
    }
    function getPropertyKey(prop) { return "immobilie_"+b64EncodeUnicode(JSON.stringify(prop)); }
    function saveContactStatus(prop,chk,di,txt) {
      localStorage.setItem(getPropertyKey(prop),JSON.stringify({contacted:chk.checked,contactDate:di.value,notes:txt.value}));
    }
    function loadContactStatus(prop,chk,di,txt) {
      const d=localStorage.getItem(getPropertyKey(prop));
      if(d){ const o=JSON.parse(d); chk.checked=o.contacted||false; di.value=o.contactDate||""; txt.value=o.notes||""; }
    }
    function getContactStatus(prop) {
      const d=localStorage.getItem(getPropertyKey(prop));
      return d?JSON.parse(d):{contacted:false,contactDate:"",notes:""};
    }

    // -------------------------------------------------------
    // 9) Statistik
    // -------------------------------------------------------
    function updateStatistics() {
      let total=filteredData.length, c=0;
      filteredData.forEach(i=>{ if(getContactStatus(i).contacted) c++; });
      statisticsDiv.textContent=`Statistik: Kontaktiert: ${c} / Nicht kontaktiert: ${total-c} / Gesamt: ${total}`;
    }

    // -------------------------------------------------------
    // 10) Navigation Einzelansicht
    // -------------------------------------------------------
    prevBtn.addEventListener('click',()=>{ if(currentIndex>0){ currentIndex--; displayCard(currentIndex);} });
    nextBtn.addEventListener('click',()=>{ if(currentIndex<filteredData.length-1){ currentIndex++; displayCard(currentIndex);} });
    function updateNavigation() { prevBtn.disabled=(currentIndex===0); nextBtn.disabled=(currentIndex===filteredData.length-1);}    

    // -------------------------------------------------------
    // 11) Toggle Ansicht
    // -------------------------------------------------------
    toggleViewBtn.addEventListener('click',()=>{
      viewMode = viewMode==="single"?"multi":"single";
      toggleViewBtn.textContent= viewMode==="single"?"Wechsel zu Mehrfachansicht":"Wechsel zu Einzelansicht";
      updateDataView();
    });

    // -------------------------------------------------------
    // 12) Hotkeys
    // -------------------------------------------------------
    window.addEventListener('keydown', e=>{
      if(viewMode==="single" && filteredData.length){
        if(e.key==="ArrowLeft"&&currentIndex>0){ currentIndex--; displayCard(currentIndex);}        
        if(e.key==="ArrowRight"&&currentIndex<filteredData.length-1){ currentIndex++; displayCard(currentIndex);}        
        if(e.key.toLowerCase()==="c"){        
          const cb=cardContainer.querySelector("input[type=checkbox]");
          if(cb){ cb.checked=!cb.checked; const di=cardContainer.querySelector("input[type=date]"); const tn=cardContainer.querySelector("textarea"); saveContactStatus(filteredData[currentIndex],cb,di,tn); updateStatistics(); }
        }
      }
    });

    // -------------------------------------------------------
    // 13) Export CSV
    // -------------------------------------------------------
    exportBtn.addEventListener('click',()=>{
      if(!mergedData.length){ alert("Keine Daten zum Exportieren vorhanden!"); return;}      
      let csv="data:text/csv;charset=utf-8,";
      const hdr=Object.keys(mergedData[0]).concat(["Kontaktiert","Kontaktiert_am","Notizen"]);
      csv+=hdr.join(",")+"\n";
      mergedData.forEach(it=>{
        const st=getContactStatus(it);
        const row=hdr.map(h=>{
          if(h==="Kontaktiert") return st.contacted?"ja":"nein";
          if(h==="Kontaktiert_am") return st.contactDate;
          if(h==="Notizen") return `"${st.notes||""}"`;
          return `"${it[h]||""}"`;
        });
        csv+=row.join(",")+"\n";
      });
      const a=document.createElement("a"); a.href=encodeURI(csv); a.download="export.csv"; document.body.append(a); a.click(); a.remove();
    });

    // -------------------------------------------------------
    // 14) Service Worker Registrierung
    // -------------------------------------------------------
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./service-worker.js').then(r=>console.log('SW registered',r.scope)).catch(e=>console.warn('SW failed',e)); }); }

    // -------------------------------------------------------
    // 15) Firebase Cloud Functions (Compat)
    // -------------------------------------------------------
    function saveDataToFirestore(data){ data.forEach(item=>{ window.db.collection("immobilien").add(item).then(r=>console.log('ID',r.id)).catch(e=>console.error(e)); }); }
    function loadDataFromFirestore(){ window.db.collection("immobilien").get().then(qs=>{ const arr=[]; qs.forEach(d=>arr.push(d.data())); mergedData=arr; filteredData=[...arr]; currentIndex=0; updateDataView(); }).catch(e=>console.error(e)); }
    saveToCloudBtn.addEventListener('click',()=>{ if(!mergedData.length){alert("Keine Daten!");return;} saveDataToFirestore(mergedData); });
    loadFromCloudBtn.addEventListener('click',loadDataFromFirestore);
  </script>
</body>
</html>
